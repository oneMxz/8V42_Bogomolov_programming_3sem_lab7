name: Build Bayan

on:
  push:
    branches: [main]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ libboost-all-dev
    
    - name: Build
      run: |
        mkdir -p build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j4
    
    - name: Test
      run: |
        ./build/bayan --help
    
    - name: Create Linux package
      run: |
        mkdir -p package/linux
        cp build/bayan package/linux/
        tar -czf bayan-linux.tar.gz package/linux
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: bayan-linux
        path: bayan-linux.tar.gz

  build-windows:
    runs-on: windows-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup MSYS2 with MinGW and Ninja
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        install: >-
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-gcc-libs
          mingw-w64-x86_64-boost
          mingw-w64-x86_64-ninja
    
    - name: Build with Ninja
      shell: msys2 {0}
      run: |
        export PATH="/mingw64/bin:$PATH"
        
        mkdir -p build && cd build
        
        # Используем Ninja вместо Make
        cmake .. \
          -G "Ninja" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_COMPILER=g++ \
          -DCMAKE_C_COMPILER=gcc
        
        # Ninja автоматически использует все ядра
        ninja
    
    - name: Test
      shell: msys2 {0}
      run: |
        ./build/bayan.exe --help || echo "Test completed"
    
    - name: Create Windows package
      shell: pwsh
      run: |
        mkdir -Force package/windows
        Copy-Item build/bayan.exe package/windows/
        Compress-Archive -Path package/windows -DestinationPath bayan-windows.zip
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: bayan-windows
        path: bayan-windows.zip

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Bayan v1.0.${{ github.run_number }}
        body: |
          ## Bayan - Duplicate File Finder
          
          ### Downloads:
          - **Windows**: `bayan-windows.zip`
          - **Linux**: `bayan-linux.tar.gz`
          
          ### Usage:
          ```bash
          # Linux
          tar -xzf bayan-linux.tar.gz
          ./bayan --include . --level 0
          
          # Windows
          # Extract bayan-windows.zip and run:
          bayan.exe --include . --level 0
          ```
        files: |
          artifacts/bayan-linux/bayan-linux.tar.gz
          artifacts/bayan-windows/bayan-windows.zip
        draft: false
        prerelease: false