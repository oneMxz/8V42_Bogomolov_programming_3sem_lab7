name: Build Bayan

on:
  push:
    branches: [main]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ libboost-all-dev
    
    - name: Build
      run: |
        mkdir -p build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j4
    
    - name: Test
      run: |
        ./build/bayan --help
    
    - name: Create Linux package
      run: |
        mkdir -p package/linux
        cp build/bayan package/linux/
        tar -czf bayan-linux.tar.gz package/linux
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: bayan-linux
        path: bayan-linux.tar.gz

  build-windows:
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Visual Studio
      uses: microsoft/setup-msbuild@v1
    
    - name: Install dependencies (Windows)
      shell: pwsh
      run: |
        # Используем vcpkg для установки Boost
        git clone https://github.com/microsoft/vcpkg.git
        cd vcpkg
        .\bootstrap-vcpkg.bat
            .\vcpkg install boost-program-options:x64-windows boost-filesystem:x64-windows 
        
        echo "VCPKG_ROOT=$pwd" >> $env:GITHUB_ENV
        echo "CMAKE_TOOLCHAIN_FILE=$pwd\scripts\buildsystems\vcpkg.cmake" >> $env:GITHUB_ENV
    
    - name: Build (Windows)
      shell: pwsh
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="$env:CMAKE_TOOLCHAIN_FILE" `
          -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release --parallel 4
    
    - name: Test (Windows)
      shell: pwsh
      run: |
        .\build\bayan.exe --help || echo "Test completed"
    
    - name: Create Windows package
      shell: pwsh
      run: |
        mkdir package/windows
        copy build\bayan.exe package\windows\
        Compress-Archive -Path package\windows -DestinationPath bayan-windows.zip
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: bayan-windows
        path: bayan-windows.zip

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Bayan v1.0.${{ github.run_number }}
        body: |
          ## Bayan - Duplicate File Finder
          
          ### Downloads:
          - **Windows**: `bayan-windows.zip`
          - **Linux**: `bayan-linux.tar.gz`
          
          ### Usage:
          ```bash
          # Linux
          tar -xzf bayan-linux.tar.gz
          ./bayan --include . --level 0
          
          # Windows
          # Extract bayan-windows.zip and run:
          bayan.exe --include . --level 0
          ```
        files: |
          artifacts/bayan-linux/bayan-linux.tar.gz
          artifacts/bayan-windows/bayan-windows.zip
        draft: false
        prerelease: false